#!/usr/bin/env python3
import json
import os
import subprocess
import sys

# Unicode levels from low → high
LEVELS = ["▁", "▂", "▃", "▄", "▅", "▆", "▇", "█"]

# Start cava and read ascii raw values continuously
proc = subprocess.Popen(
    ["cava", "-p", f"{os.path.expanduser('~')}/.config/cava/config"],
    stdout=subprocess.PIPE,
    stderr=subprocess.DEVNULL,
    text=True,
    bufsize=1,
)

try:
    for line in proc.stdout:
        # line example: "0;1;0;3;7;5;..." (0..7 per bar)
        parts = [p for p in line.strip().split(";") if p != ""]
        if not parts:
            continue
        # Map values to unicode blocks
        bars = "".join(LEVELS[min(int(x), len(LEVELS) - 1)] for x in parts)
        # Waybar custom module text (keep it lightweight)
        payload = {"text": bars, "class": "viz"}
        print(json.dumps(payload), flush=True)
except BrokenPipeError:
    pass
finally:
    proc.kill()
